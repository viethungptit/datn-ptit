# =============================
# üß± 1Ô∏è‚É£ Builder stage - build b·∫±ng Maven
# =============================
FROM maven:3.9.11-amazoncorretto-24-alpine AS builder
WORKDIR /workspace

# Copy file c·∫•u h√¨nh Maven ƒë·ªÉ cache dependency
COPY pom.xml mvnw* ./
COPY .mvn .mvn

# T·∫£i dependency (cache)
RUN --mount=type=cache,target=/root/.m2 \
    mvn -B dependency:go-offline

# Copy source v√† build (b·ªè test)
COPY src ./src
RUN --mount=type=cache,target=/root/.m2 \
    mvn -B -DskipTests package

# =============================
# ‚òï 2Ô∏è‚É£ Extract stage - ch·ªâ l·∫•y JAR dependencies (gi·∫£m layer)
# =============================
FROM amazoncorretto:24-alpine-jdk AS extractor
WORKDIR /extract
COPY --from=builder /workspace/target/*.jar app.jar
RUN java -Djarmode=layertools -jar app.jar extract

# =============================
# üöÄ 3Ô∏è‚É£ Runtime stage - c·ª±c nh·∫π
# =============================
FROM eclipse-temurin:24-jre-alpine AS runtime

# T·∫°o user kh√¥ng ph·∫£i root
ARG APP_USER=appuser
RUN addgroup -S ${APP_USER} && adduser -S ${APP_USER} -G ${APP_USER}
USER ${APP_USER}

WORKDIR /app
COPY --from=extractor /extract/dependencies/ ./
COPY --from=extractor /extract/spring-boot-loader/ ./
COPY --from=extractor /extract/snapshot-dependencies/ ./
COPY --from=extractor /extract/application/ ./

EXPOSE 5004
ENTRYPOINT ["java", "org.springframework.boot.loader.launch.JarLauncher"]
